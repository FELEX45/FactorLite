<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FactorLite — Content Editor</title>
    <style>
      :root {
        --bg: #0b0d12;
        --panel: #111523;
        --muted: #8ea0b8;
        --text: #e9eef7;
        --accent: #7aa2ff;
        --danger: #ff6b6b;
        --ok: #3ddc97;
        --border: rgba(255, 255, 255, 0.10);
        --shadow: 0 12px 30px rgba(0,0,0,0.45);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: var(--sans);
        background: radial-gradient(1200px 600px at 15% 0%, rgba(122,162,255,0.12), transparent 55%),
                    radial-gradient(1200px 600px at 85% 0%, rgba(61,220,151,0.10), transparent 55%),
                    var(--bg);
        color: var(--text);
      }
      header {
        padding: 18px 18px 0;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 6px 0;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.45;
        margin: 0 0 14px 0;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 18px 22px;
        display: grid;
        grid-template-columns: 1.05fr 0.95fr;
        gap: 14px;
      }
      .card {
        background: rgba(17, 21, 35, 0.88);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card .hd {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: space-between;
      }
      .card .hd strong { font-size: 13px; }
      .card .bd { padding: 14px; }
      .tabs {
        display: inline-flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .tab {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        padding: 7px 10px;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
      }
      .tab[data-active="true"] {
        border-color: rgba(122,162,255,0.55);
        background: rgba(122,162,255,0.14);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 5px;
      }
      input, select, textarea {
        width: 100%;
        background: rgba(0,0,0,0.22);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 10px;
        outline: none;
      }
      textarea { min-height: 74px; resize: vertical; font-family: var(--mono); font-size: 12px; }
      .row { display: flex; gap: 10px; align-items: center; }
      .row > * { flex: 1; }
      .btns { display: flex; gap: 8px; flex-wrap: wrap; }
      button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
      }
      button.primary {
        border-color: rgba(122,162,255,0.55);
        background: rgba(122,162,255,0.14);
      }
      button.danger {
        border-color: rgba(255,107,107,0.55);
        background: rgba(255,107,107,0.12);
      }
      button.ok {
        border-color: rgba(61,220,151,0.55);
        background: rgba(61,220,151,0.12);
      }
      .hint {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.45;
      }
      pre {
        margin: 0;
        padding: 12px 14px;
        overflow: auto;
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.4;
        white-space: pre;
      }
      .list {
        margin-top: 10px;
        border-top: 1px dashed rgba(255,255,255,0.14);
        padding-top: 10px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: rgba(0,0,0,0.16);
        margin: 0 8px 8px 0;
        font-size: 12px;
      }
      .pill small { color: var(--muted); }
      .pill button {
        padding: 4px 7px;
        border-radius: 8px;
      }
      .mono { font-family: var(--mono); }
      @media (max-width: 980px) {
        .wrap { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>FactorLite — редактор контента (оружия/пассивки/сундуки/шрайны)</h1>
      <p class="sub">
        Это <b>локальная HTML‑страница</b> (без сервера): открой файл двойным кликом.
        Слева добавляешь сущности, справа получаешь итоговый <b>YAML</b> (под шаблон) и <b>JSON</b>.
      </p>
    </header>

    <div class="wrap">
      <section class="card" id="editorCard">
        <div class="hd">
          <div class="tabs" id="tabs">
            <div class="tab" data-tab="weapons" data-active="true">Оружия</div>
            <div class="tab" data-tab="passives">Пассивки</div>
            <div class="tab" data-tab="items">Сундуки (предметы)</div>
            <div class="tab" data-tab="shrines">Шрайны (глобал)</div>
          </div>
          <div class="btns">
            <button class="danger" id="btnReset">Сбросить всё</button>
          </div>
        </div>
        <div class="bd">
          <!-- Weapons -->
          <div data-pane="weapons">
            <div class="grid">
              <div>
                <label>ID (например BLASTER)</label>
                <input id="w_id" placeholder="BLASTER" />
              </div>
              <div>
                <label>UI имя</label>
                <input id="w_uiName" placeholder="Бластер" />
              </div>
              <div>
                <label>Роль (любое описание)</label>
                <input id="w_role" placeholder="основной, стабильный ДПС" />
              </div>
              <div>
                <label>Тип (для себя)</label>
                <input id="w_type" placeholder="projectile / melee / beam ..." />
              </div>
            </div>

            <div class="hint"><b>База</b></div>
            <div class="grid">
              <div><label>damage</label><input id="w_base_damage" type="number" step="0.1" value="10" /></div>
              <div><label>cooldownSec</label><input id="w_base_cooldown" type="number" step="0.01" value="0.35" /></div>
              <div><label>projectileSpeed</label><input id="w_base_speed" type="number" step="1" value="780" /></div>
              <div><label>spreadRad</label><input id="w_base_spread" type="number" step="0.01" value="0.10" /></div>
              <div><label>range</label><input id="w_base_range" type="number" step="1" value="520" /></div>
              <div><label>Примечание</label><input id="w_base_note" placeholder="если нужно" /></div>
            </div>
            <div class="hint" id="w_dpsHint">
              <b>Ориентир по балансу</b>: normal враг = <span class="mono">40 HP</span>, стартовый бластер ≈ <span class="mono">28.6 DPS</span>.
              Для нового “стартового” оружия держи базовый DPS примерно <span class="mono">25–32</span> (single‑target). Для AOE/клива — ниже.
              <br />
              <b>Текущий DPS</b> (damage / cooldown): <span class="mono" id="w_dps">—</span>
            </div>

            <div class="hint"><b>Карточки апгрейдов (паттерн)</b> — добавляй по одной</div>
            <div class="grid">
              <div>
                <label>Upgrade kind</label>
                <input id="wu_kind" list="wu_kind_list" placeholder="любой ID, например DAMAGE" />
                <datalist id="wu_kind_list">
                  <option value="DAMAGE"></option>
                  <option value="FIRE_RATE"></option>
                  <option value="PROJECTILE_SPEED"></option>
                  <option value="ACCURACY"></option>
                  <option value="RANGE"></option>
                </datalist>
              </div>
              <div><label>cap</label><input id="wu_cap" type="number" step="1" value="10" /></div>
              <div>
                <label>weight</label>
                <div class="row">
                  <input id="wu_weight" type="number" step="0.1" value="3.0" />
                  <select id="wu_weightPreset" title="Пресет частоты выпадения">
                    <option value="custom" selected>свой</option>
                    <option value="often">часто</option>
                    <option value="medium">средне</option>
                    <option value="rare">редко</option>
                    <option value="very_rare">очень редко</option>
                  </select>
                </div>
              </div>
              <div><label>effectPerStep (JSON)</label><input id="wu_effect" placeholder='{"damagePlus":2.2}' /></div>
            </div>
            <div class="hint">
              <b>Что такое cap и weight</b>:
              cap — максимальный уровень конкретной карточки (если достигнут, она больше не выпадает).
              weight — относительная вероятность внутри пула кандидатов: например 3.0 выпадает примерно в 3 раза чаще, чем 1.0 (при прочих равных).
            </div>
            <div class="btns" style="margin-top:10px;">
              <button class="ok" id="btnAddWeaponUpgrade">Добавить апгрейд к оружию</button>
            </div>
            <div class="list" id="weaponUpgradesList"></div>

            <div class="hint"><b>Моды (EXTRA/RICOCHET/PIERCE)</b> — опционально</div>
            <div class="grid">
              <div>
                <label>Mod kind</label>
                <input id="wm_kind" list="wm_kind_list" placeholder="любой ID, например RICOCHET" />
                <datalist id="wm_kind_list">
                  <option value="EXTRA"></option>
                  <option value="RICOCHET"></option>
                  <option value="PIERCE"></option>
                </datalist>
              </div>
              <div><label>cap</label><input id="wm_cap" type="number" step="1" value="2" /></div>
              <div>
                <label>weight</label>
                <div class="row">
                  <input id="wm_weight" type="number" step="0.1" value="2.8" />
                  <select id="wm_weightPreset" title="Пресет частоты выпадения">
                    <option value="custom" selected>свой</option>
                    <option value="often">часто</option>
                    <option value="medium">средне</option>
                    <option value="rare">редко</option>
                    <option value="very_rare">очень редко</option>
                  </select>
                </div>
              </div>
              <div><label>effect (текст)</label><input id="wm_effect" placeholder="+1 рикошет" /></div>
            </div>
            <div class="btns" style="margin-top:10px;">
              <button class="ok" id="btnAddWeaponMod">Добавить мод к оружию</button>
            </div>
            <div class="list" id="weaponModsList"></div>

            <div class="btns" style="margin-top:14px;">
              <button class="primary" id="btnAddWeapon">Добавить оружие в список</button>
              <button id="btnClearWeaponForm">Очистить форму</button>
            </div>
            <div class="list" id="weaponsList"></div>
          </div>

          <!-- Passives -->
          <div data-pane="passives" style="display:none;">
            <div class="grid">
              <div><label>ID (например DAMAGE)</label><input id="p_id" placeholder="DAMAGE" /></div>
              <div><label>UI имя</label><input id="p_uiName" placeholder="+Урон" /></div>
              <div><label>Роль</label><input id="p_role" placeholder="скейл ДПС" /></div>
              <div><label>cap уровней</label><input id="p_cap" type="number" step="1" value="20" /></div>
              <div><label>perLevel (число)</label><input id="p_perLevel" type="number" step="0.01" value="0.12" /></div>
              <div><label>Примечание</label><input id="p_note" placeholder="если нужно" /></div>
            </div>
            <div class="btns" style="margin-top:14px;">
              <button class="primary" id="btnAddPassive">Добавить пассивку</button>
              <button id="btnClearPassiveForm">Очистить форму</button>
            </div>
            <div class="list" id="passivesList"></div>
          </div>

          <!-- Items -->
          <div data-pane="items" style="display:none;">
            <div class="grid">
              <div><label>ID (например LIGHTNING_ORB)</label><input id="i_id" placeholder="LIGHTNING_ORB" /></div>
              <div><label>UI имя</label><input id="i_uiName" placeholder="Сфера молнии" /></div>
              <div>
                <label>dropWeight</label>
                <div class="row">
                  <input id="i_weight" type="number" step="0.1" value="1.0" />
                  <select id="i_weightPreset" title="Пресет частоты выпадения из сундука">
                    <option value="custom" selected>свой</option>
                    <option value="often">часто</option>
                    <option value="medium">средне</option>
                    <option value="rare">редко</option>
                    <option value="very_rare">очень редко</option>
                  </select>
                </div>
              </div>
              <div><label>Описание/роль</label><input id="i_role" placeholder="прок молнии по попаданию" /></div>
            </div>
            <div class="hint"><b>Параметры по редкостям</b> — вставляй JSON для каждой редкости</div>
            <div class="grid">
              <div><label>COMMON (JSON)</label><input id="i_common" placeholder='{"procChance":0.25,"damage":10,"chains":0}' /></div>
              <div><label>RARE (JSON)</label><input id="i_rare" placeholder='{"procChance":0.35,"damage":14,"chains":1}' /></div>
              <div><label>EPIC (JSON)</label><input id="i_epic" placeholder='{"procChance":0.45,"damage":20,"chains":2}' /></div>
              <div><label>LEGENDARY (JSON)</label><input id="i_leg" placeholder='{"procChance":0.60,"damage":30,"chains":3}' /></div>
            </div>
            <div class="btns" style="margin-top:14px;">
              <button class="primary" id="btnAddItem">Добавить предмет</button>
              <button id="btnClearItemForm">Очистить форму</button>
            </div>
            <div class="list" id="itemsList"></div>
          </div>

          <!-- Shrines -->
          <div data-pane="shrines" style="display:none;">
            <div class="grid">
              <div><label>standSeconds</label><input id="s_stand" type="number" step="0.1" value="2.6" /></div>
              <div><label>optionsCount</label><input id="s_count" type="number" step="1" value="3" /></div>
              <div>
                <label>allowSkip</label>
                <select id="s_skip">
                  <option value="true" selected>true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div><label>Примечание</label><input id="s_note" placeholder="если нужно" /></div>
            </div>
            <div class="hint"><b>Бонусы</b> — добавляй по одному</div>
            <div class="grid">
              <div><label>ID (например DAMAGE)</label><input id="sb_id" placeholder="DAMAGE" /></div>
              <div><label>UI имя</label><input id="sb_uiName" placeholder="Урон" /></div>
              <div>
                <label>weight</label>
                <div class="row">
                  <input id="sb_weight" type="number" step="0.1" value="1.0" />
                  <select id="sb_weightPreset" title="Пресет частоты появления бонуса в выборе">
                    <option value="custom" selected>свой</option>
                    <option value="often">часто</option>
                    <option value="medium">средне</option>
                    <option value="rare">редко</option>
                    <option value="very_rare">очень редко</option>
                  </select>
                </div>
              </div>
              <div><label>COMMON amount</label><input id="sb_common" type="number" step="0.01" value="0.06" /></div>
              <div><label>RARE amount</label><input id="sb_rare" type="number" step="0.01" value="0.12" /></div>
              <div><label>EPIC amount</label><input id="sb_epic" type="number" step="0.01" value="0.18" /></div>
            </div>
            <div class="btns" style="margin-top:14px;">
              <button class="ok" id="btnAddShrineBonus">Добавить бонус</button>
              <button class="primary" id="btnSaveShrineRules">Сохранить правила шрайна</button>
            </div>
            <div class="list" id="shrinesList"></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <strong>Вывод</strong>
          <div class="btns">
            <button class="ok" id="btnCopyYaml">Скопировать YAML</button>
            <button id="btnDownloadYaml">Скачать YAML</button>
            <button id="btnCopyJson">Скопировать JSON</button>
          </div>
        </div>
        <div class="bd" style="padding:0;">
          <pre id="out"></pre>
        </div>
      </section>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const storeKey = "factorlite_content_editor_v1";
      const state = loadState();

      function loadState() {
        try {
          const raw = localStorage.getItem(storeKey);
          if (raw) return JSON.parse(raw);
        } catch {}
        return {
          meta: { runDurationSec: 300 },
          weapons: [],
          passives: [],
          items: [],
          shrines: {
            rules: { standSeconds: 2.6, optionsCount: 3, allowSkip: true },
            bonuses: [],
          },
        };
      }

      function saveState() {
        localStorage.setItem(storeKey, JSON.stringify(state));
        renderAll();
      }

      function normId(s) {
        return (s || "").trim().toUpperCase().replace(/\s+/g, "_");
      }

      function num(v, fallback = 0) {
        const s = String(v ?? "").trim().replace(",", ".");
        const n = Number(s);
        return Number.isFinite(n) ? n : fallback;
      }

      function safeParseJson(s, defaultObj = {}) {
        const t = (s || "").trim();
        if (!t) return defaultObj;
        try { return JSON.parse(t); } catch { return null; }
      }

      function yq(s) {
        const t = String(s ?? "");
        // простая YAML-строка: всегда в кавычках (без сюрпризов)
        return JSON.stringify(t);
      }

      function toYaml(obj, indent = 0) {
        const sp = "  ".repeat(indent);
        if (obj === null || obj === undefined) return "null";
        if (typeof obj === "string") return yq(obj);
        if (typeof obj === "number" || typeof obj === "boolean") return String(obj);
        if (Array.isArray(obj)) {
          if (obj.length === 0) return "[]";
          return obj
            .map((v) => {
              if (typeof v === "object" && v !== null) {
                return `${sp}-\n${toYaml(v, indent + 1)}`;
              }
              return `${sp}- ${toYaml(v, 0)}`;
            })
            .join("\n");
        }
        // object
        const keys = Object.keys(obj);
        if (keys.length === 0) return "{}";
        return keys
          .map((k) => {
            const v = obj[k];
            if (typeof v === "object" && v !== null && !Array.isArray(v)) {
              // Пустые объекты печатаем в одну строку, иначе YAML ломается от отсутствия отступа.
              const subKeys = Object.keys(v);
              if (subKeys.length === 0) return `${sp}${k}: {}`;
              return `${sp}${k}:\n${toYaml(v, indent + 1)}`;
            }
            if (Array.isArray(v)) {
              // Пустые массивы — тоже в одну строку.
              if (v.length === 0) return `${sp}${k}: []`;
              return `${sp}${k}:\n${toYaml(v, indent + 1)}`;
            }
            return `${sp}${k}: ${toYaml(v, 0)}`;
          })
          .join("\n");
      }

      function buildTemplate() {
        return {
          meta: { runDurationSec: state.meta.runDurationSec },
          weapons: state.weapons.map((w) => ({
            id: w.id,
            uiName: w.uiName,
            role: w.role || "",
            type: w.type || "",
            base: { ...w.base },
            upgrades: { ...w.upgrades },
            mods: { ...w.mods },
          })),
          passives: state.passives.map((p) => ({
            id: p.id,
            uiName: p.uiName,
            role: p.role || "",
            levels: { cap: p.cap, perLevel: p.perLevel },
          })),
          items: state.items.map((it) => ({
            id: it.id,
            uiName: it.uiName,
            role: it.role || "",
            dropWeight: it.dropWeight,
            rarities: it.rarities,
          })),
          shrines: {
            rules: { ...state.shrines.rules },
            bonuses: state.shrines.bonuses.map((b) => ({
              id: b.id,
              uiName: b.uiName,
              weight: b.weight,
              rarities: b.rarities,
            })),
          },
        };
      }

      function renderAll() {
        // lists
        renderWeapons();
        renderPassives();
        renderItems();
        renderShrines();
        // output
        const tmpl = buildTemplate();
        const yaml = toYaml(tmpl, 0);
        $("out").textContent = yaml + "\n";
      }

      // Tabs
      $("tabs").addEventListener("click", (e) => {
        const t = e.target?.closest(".tab");
        if (!t) return;
        const tab = t.getAttribute("data-tab");
        $$(".tab").forEach((x) => x.setAttribute("data-active", String(x.getAttribute("data-tab") === tab)));
        $$("[data-pane]").forEach((p) => (p.style.display = p.getAttribute("data-pane") === tab ? "" : "none"));
      });

      // Reset
      $("btnReset").addEventListener("click", () => {
        if (!confirm("Точно сбросить всё?")) return;
        localStorage.removeItem(storeKey);
        location.reload();
      });

      // Weapons temporary accumulators
      let wUpgradesTmp = [];
      let wModsTmp = [];
      function renderWeaponTmp() {
        $("weaponUpgradesList").innerHTML = wUpgradesTmp
          .map((u, idx) => {
            return `<span class="pill"><span class="mono">${u.kind}</span> <small>cap=${u.cap}, w=${u.weight}</small>
              <button class="danger" data-del-up="${idx}">x</button></span>`;
          })
          .join("");
        $("weaponModsList").innerHTML = wModsTmp
          .map((m, idx) => {
            return `<span class="pill"><span class="mono">${m.kind}</span> <small>cap=${m.cap}, w=${m.weight}</small>
              <button class="danger" data-del-mod="${idx}">x</button></span>`;
          })
          .join("");
      }

      $("weaponUpgradesList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-up]");
        if (!btn) return;
        const idx = Number(btn.getAttribute("data-del-up"));
        wUpgradesTmp.splice(idx, 1);
        renderWeaponTmp();
      });
      $("weaponModsList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-mod]");
        if (!btn) return;
        const idx = Number(btn.getAttribute("data-del-mod"));
        wModsTmp.splice(idx, 1);
        renderWeaponTmp();
      });

      $("btnAddWeaponUpgrade").addEventListener("click", () => {
        const kind = normId($("wu_kind").value);
        if (!kind) return alert("Upgrade kind: заполни ID");
        const cap = num($("wu_cap").value, 0);
        const weight = num($("wu_weight").value, 0);
        const effectRaw = $("wu_effect").value;
        const effect = safeParseJson(effectRaw, {});
        if (effect === null) return alert("effectPerStep: невалидный JSON");
        wUpgradesTmp.push({ kind, cap, weight, effect });
        renderWeaponTmp();
      });

      $("btnAddWeaponMod").addEventListener("click", () => {
        const kind = normId($("wm_kind").value);
        if (!kind) return alert("Mod kind: заполни ID");
        const cap = num($("wm_cap").value, 0);
        const weight = num($("wm_weight").value, 0);
        const effect = ($("wm_effect").value || "").trim();
        wModsTmp.push({ kind, cap, weight, effect });
        renderWeaponTmp();
      });

      $("btnAddWeapon").addEventListener("click", () => {
        const id = normId($("w_id").value);
        const uiName = ($("w_uiName").value || "").trim();
        if (!id) return alert("Оружие: заполни ID");
        if (!uiName) return alert("Оружие: заполни UI имя");

        const base = {
          damage: num($("w_base_damage").value),
          cooldownSec: num($("w_base_cooldown").value),
          projectileSpeed: num($("w_base_speed").value),
          spreadRad: num($("w_base_spread").value),
          range: num($("w_base_range").value),
          note: ($("w_base_note").value || "").trim(),
        };

        const upgrades = {};
        for (const u of wUpgradesTmp) {
          upgrades[u.kind] = {
            cap: u.cap,
            weight: u.weight,
            raritySteps: { COMMON: 1, RARE: 2, EPIC: 4, LEGENDARY: 7 },
            effectPerStep: u.effect,
          };
        }

        const mods = {};
        for (const m of wModsTmp) {
          mods[m.kind] = {
            cap: m.cap,
            weight: m.weight,
            effect: m.effect,
          };
        }

        const weapon = {
          id,
          uiName,
          role: ($("w_role").value || "").trim(),
          type: ($("w_type").value || "").trim(),
          base,
          upgrades,
          mods,
        };

        const existing = state.weapons.findIndex((x) => x.id === id);
        if (existing >= 0) state.weapons[existing] = weapon;
        else state.weapons.push(weapon);

        // clear tmp
        wUpgradesTmp = [];
        wModsTmp = [];
        renderWeaponTmp();
        saveState();
      });

      $("btnClearWeaponForm").addEventListener("click", () => {
        ["w_id","w_uiName","w_role","w_type","w_base_note","wu_effect","wm_effect"].forEach((x)=>$(x).value="");
        renderWeaponTmp();
      });

      function renderWeapons() {
        $("weaponsList").innerHTML = state.weapons
          .map((w) => {
            const ups = Object.keys(w.upgrades || {}).length;
            const mods = Object.keys(w.mods || {}).length;
            return `<span class="pill"><span class="mono">${w.id}</span> <small>${w.uiName}</small>
              <small>up=${ups}, mods=${mods}</small>
              <button class="danger" data-del-weapon="${w.id}">удалить</button></span>`;
          })
          .join("");
      }
      $("weaponsList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-weapon]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-weapon");
        state.weapons = state.weapons.filter((w) => w.id !== id);
        saveState();
      });

      // Passives
      $("btnAddPassive").addEventListener("click", () => {
        const id = normId($("p_id").value);
        const uiName = ($("p_uiName").value || "").trim();
        if (!id) return alert("Пассивка: заполни ID");
        if (!uiName) return alert("Пассивка: заполни UI имя");
        const p = {
          id,
          uiName,
          role: ($("p_role").value || "").trim(),
          cap: num($("p_cap").value, 0),
          perLevel: num($("p_perLevel").value, 0),
          note: ($("p_note").value || "").trim(),
        };
        const existing = state.passives.findIndex((x) => x.id === id);
        if (existing >= 0) state.passives[existing] = p;
        else state.passives.push(p);
        saveState();
      });
      $("btnClearPassiveForm").addEventListener("click", () => {
        ["p_id","p_uiName","p_role","p_note"].forEach((x)=>$(x).value="");
      });
      function renderPassives() {
        $("passivesList").innerHTML = state.passives
          .map((p) => `<span class="pill"><span class="mono">${p.id}</span> <small>${p.uiName}</small>
            <small>cap=${p.cap}, per=${p.perLevel}</small>
            <button class="danger" data-del-passive="${p.id}">удалить</button></span>`)
          .join("");
      }
      $("passivesList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-passive]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-passive");
        state.passives = state.passives.filter((p) => p.id !== id);
        saveState();
      });

      // Items
      $("btnAddItem").addEventListener("click", () => {
        const id = normId($("i_id").value);
        const uiName = ($("i_uiName").value || "").trim();
        if (!id) return alert("Предмет: заполни ID");
        if (!uiName) return alert("Предмет: заполни UI имя");
        const rarities = {};
        const c = safeParseJson($("i_common").value, {});
        const r = safeParseJson($("i_rare").value, {});
        const e = safeParseJson($("i_epic").value, {});
        const l = safeParseJson($("i_leg").value, {});
        if (c === null || r === null || e === null || l === null) return alert("Редкости: где-то невалидный JSON");
        rarities.COMMON = c;
        rarities.RARE = r;
        rarities.EPIC = e;
        rarities.LEGENDARY = l;
        const it = {
          id,
          uiName,
          role: ($("i_role").value || "").trim(),
          dropWeight: num($("i_weight").value, 1),
          rarities,
        };
        const existing = state.items.findIndex((x) => x.id === id);
        if (existing >= 0) state.items[existing] = it;
        else state.items.push(it);
        saveState();
      });
      $("btnClearItemForm").addEventListener("click", () => {
        ["i_id","i_uiName","i_role","i_common","i_rare","i_epic","i_leg"].forEach((x)=>$(x).value="");
      });
      function renderItems() {
        $("itemsList").innerHTML = state.items
          .map((it) => `<span class="pill"><span class="mono">${it.id}</span> <small>${it.uiName}</small>
            <small>w=${it.dropWeight}</small>
            <button class="danger" data-del-item="${it.id}">удалить</button></span>`)
          .join("");
      }
      $("itemsList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-item]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-item");
        state.items = state.items.filter((it) => it.id !== id);
        saveState();
      });

      // Shrines
      $("btnSaveShrineRules").addEventListener("click", () => {
        state.shrines.rules = {
          standSeconds: num($("s_stand").value, 2.6),
          optionsCount: Math.max(1, Math.floor(num($("s_count").value, 3))),
          allowSkip: $("s_skip").value === "true",
          note: ($("s_note").value || "").trim(),
        };
        saveState();
      });
      $("btnAddShrineBonus").addEventListener("click", () => {
        const id = normId($("sb_id").value);
        const uiName = ($("sb_uiName").value || "").trim();
        if (!id) return alert("Бонус: заполни ID");
        if (!uiName) return alert("Бонус: заполни UI имя");
        const b = {
          id,
          uiName,
          weight: num($("sb_weight").value, 1),
          rarities: {
            COMMON: num($("sb_common").value, 0),
            RARE: num($("sb_rare").value, 0),
            EPIC: num($("sb_epic").value, 0),
          },
        };
        const existing = state.shrines.bonuses.findIndex((x) => x.id === id);
        if (existing >= 0) state.shrines.bonuses[existing] = b;
        else state.shrines.bonuses.push(b);
        saveState();
      });
      function renderShrines() {
        $("shrinesList").innerHTML = state.shrines.bonuses
          .map((b) => `<span class="pill"><span class="mono">${b.id}</span> <small>${b.uiName}</small>
            <small>w=${b.weight}</small>
            <button class="danger" data-del-bonus="${b.id}">удалить</button></span>`)
          .join("");
      }
      $("shrinesList").addEventListener("click", (e) => {
        const btn = e.target?.closest("button[data-del-bonus]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-bonus");
        state.shrines.bonuses = state.shrines.bonuses.filter((b) => b.id !== id);
        saveState();
      });

      // Output actions
      $("btnCopyYaml").addEventListener("click", async () => {
        const yaml = $("out").textContent || "";
        await navigator.clipboard.writeText(yaml);
        alert("YAML скопирован в буфер");
      });
      $("btnCopyJson").addEventListener("click", async () => {
        const json = JSON.stringify(buildTemplate(), null, 2);
        await navigator.clipboard.writeText(json);
        alert("JSON скопирован в буфер");
      });
      $("btnDownloadYaml").addEventListener("click", () => {
        const yaml = $("out").textContent || "";
        const blob = new Blob([yaml], { type: "text/yaml;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "factorlite_content.yaml";
        a.click();
        URL.revokeObjectURL(a.href);
      });

      // Init
      function updateWeaponDps() {
        const dmg = num($("w_base_damage").value, 0);
        const cd = Math.max(0.0001, num($("w_base_cooldown").value, 0));
        const dps = dmg / cd;
        $("w_dps").textContent = Number.isFinite(dps) ? dps.toFixed(1) : "—";
      }
      ["w_base_damage","w_base_cooldown"].forEach((id) => {
        $(id).addEventListener("input", updateWeaponDps);
      });
      updateWeaponDps();

      // Presets for weights (human-friendly)
      const WEIGHT_PRESETS = {
        often: 4.0,
        medium: 2.0,
        rare: 1.0,
        very_rare: 0.5,
      };
      function bindWeightPreset(selectId, inputId) {
        const sel = $(selectId);
        const inp = $(inputId);
        if (!sel || !inp) return;
        sel.addEventListener("change", () => {
          const key = sel.value;
          if (key === "custom") return;
          const v = WEIGHT_PRESETS[key];
          if (v === undefined) return;
          inp.value = String(v);
          inp.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }
      bindWeightPreset("wu_weightPreset", "wu_weight");
      bindWeightPreset("wm_weightPreset", "wm_weight");
      bindWeightPreset("i_weightPreset", "i_weight");
      bindWeightPreset("sb_weightPreset", "sb_weight");

      renderWeaponTmp();
      renderAll();
      saveState(); // ensure it exists
    </script>
  </body>
</html>

